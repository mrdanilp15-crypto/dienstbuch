<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Digitales Dienstbuch</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" href="/static/favicon.svg">
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <style>
        :root { --primary-color: #b71c1c; --bg-color: #f4f6f8; --exercise-color: #0d6efd; --incident-color: #dc3545; --misc-color: #ffc107; }
        body { background-color: var(--bg-color); font-family: 'Segoe UI', sans-serif; height: 100dvh; overflow: hidden; }
        .app-container { display: flex; height: 100dvh; }
        .sidebar { width: 280px; background: white; border-right: 1px solid #e0e0e0; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 10px rgba(0,0,0,0.03); }
        .group-item { padding: 14px 20px; cursor: pointer; border-left: 5px solid transparent; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; border-bottom: 1px solid #f8f9fa; }
        .group-item.active { border-left-color: var(--primary-color); background: #fff5f5; color: var(--primary-color); font-weight: bold; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: 25px; width: 100%; scroll-behavior: smooth; position: relative; }
        .mobile-nav { display: none; background: white; border-bottom: 1px solid #e0e0e0; padding: 10px 15px; align-items: center; justify-content: space-between; z-index: 1100; }
        @media (max-width: 991px) { .app-container { flex-direction: column; } .sidebar { display: none !important; } .mobile-nav { display: flex; } body { overflow: auto; } .main-content { padding: 15px; } }
        .update-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); z-index: 2000; background: #b71c1c; color: white; padding: 12px 25px; border-radius: 50px; box-shadow: 0 10px 30px rgba(183, 28, 28, 0.4); display: flex; align-items: center; gap: 15px; animation: slideDown 0.4s ease-out; }
        @keyframes slideDown { from { top: -60px; opacity: 0; } to { top: 20px; opacity: 1; } }
        .stat-card { border: none; border-radius: 18px; color: white; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        .rank-card { border-radius: 20px; border: none; box-shadow: 0 4px 20px rgba(0,0,0,0.05); background: white; margin-bottom: 25px; }
        .rank-badge { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.85rem; }
        .rank-1 { background: linear-gradient(135deg, #ffd700, #ffb900); color: #000; }
        .rank-2 { background: linear-gradient(135deg, #e0e0e0, #bdbdbd); color: #333; }
        .rank-3 { background: linear-gradient(135deg, #f0a070, #cd7f32); color: #fff; }
        .session-item { background: white; border-radius: 20px !important; border: none !important; margin-bottom: 15px; padding: 18px 25px; box-shadow: 0 3px 12px rgba(0,0,0,0.04); transition: all 0.2s ease; cursor: pointer; }
        .btn-icon { background: transparent; border: none; padding: 6px; color: #ccc; }
        .sig-wrapper { border: 2px dashed #ddd; background: white; border-radius: 15px; overflow: hidden; height: 250px; }
        #sigCanvas { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="app">
        <div v-if="updateCountdown > 0" class="update-overlay"><i class="fa fa-sync fa-spin"></i><span class="fw-bold">Update läuft... Neustart in {{ updateCountdown }}s</span></div>
        <div class="mobile-nav shadow-sm">
            <div class="fw-bold text-danger"><i class="fa fa-fire-extinguisher me-2"></i>DIENSTBUCH</div>
            <select v-model="mobileSelectedId" class="form-select form-select-sm w-50 rounded-pill" @change="onMobileGroupChange"><option v-for="g in groups" :key="g.id" :value="g.id">{{ g.name }}</option></select>
            <button class="btn btn-sm btn-dark rounded-circle shadow-sm" @click="fullLogout"><i class="fa fa-sign-out-alt"></i></button>
        </div>
        <div class="app-container">
            <div class="sidebar">
                <div class="p-4 text-center border-bottom"><h4 class="m-0 fw-bold text-danger">FEUERWEHR</h4><small class="text-muted fw-bold" style="font-size: 0.6rem;">DIGITALES DIENSTBUCH</small></div>
                <div class="flex-grow-1 overflow-y-auto pt-2">
                    <div v-for="g in groups" :key="g.id" class="group-item" :class="{active: selectedGroup?.id === g.id}" @click="selectGroup(g)"><span>{{ g.name }}</span><div v-if="isAdmin" class="d-flex gap-1"><button class="btn-icon" @click.stop="editGroup(g)"><i class="fa fa-edit"></i></button><button class="btn-icon text-danger" @click.stop="deleteGroup(g)"><i class="fa fa-trash-alt"></i></button></div></div>
                </div>
                <div class="p-3 bg-light border-top">
                    <button v-if="isAdmin" class="btn btn-outline-danger btn-sm w-100 mb-2 rounded-pill fw-bold" @click="addGroup"><i class="fa fa-plus-circle me-1"></i> Neue Liste</button>
                    <button v-if="isAdmin" class="btn btn-warning btn-sm w-100 mb-2 rounded-pill fw-bold" @click="runSystemUpdateAction"><i class="fa fa-sync-alt me-1"></i> System Update</button>
                    <button class="btn btn-outline-info btn-sm w-100 mb-2 rounded-pill fw-bold" @click="showAbout"><i class="fa fa-info-circle me-1"></i> Projekt Info</button>
                    <hr>
                    <button v-if="!isAdmin" class="btn btn-primary btn-sm w-100 rounded-pill shadow-sm fw-bold mb-2" @click="promptAdmin"><i class="fa fa-lock me-1"></i> Admin Login</button>
                    <button v-else class="btn btn-dark btn-sm w-100 rounded-pill shadow-sm fw-bold mb-2" @click="logoutAdminOnly"><i class="fa fa-unlock me-1"></i> Admin Logout</button>
                    <button class="btn btn-outline-dark btn-sm w-100 rounded-pill fw-bold" @click="fullLogout"><i class="fa fa-sign-out-alt me-1"></i> Komplett Logout</button>
                    <div class="text-center mt-3"><small class="text-muted" style="font-size: 0.6rem;">Version 1.58 | Standard Edition</small></div>
                </div>
            </div>
            <div class="main-content">
                <div v-if="selectedGroup">
                    <div class="d-flex justify-content-between align-items-end mb-4 flex-wrap gap-3">
                        <div><h1 class="fw-bold m-0" style="font-size: 2.3rem; letter-spacing: -1px;">{{ selectedGroup.name }}</h1>
                            <select v-model="selectedYear" class="form-select form-select-sm border-0 shadow-sm rounded-pill mt-2" style="width: auto; cursor: pointer;" @change="loadData"><option v-for="y in [2024,2025,2026]" :value="y">Jahr {{ y }}</option></select>
                        </div>
                        <div class="d-flex gap-2">
                            <a :href="`/groups/${selectedGroup.id}/print_view?year=${selectedYear}`" target="_blank" class="btn btn-white border shadow-sm rounded-pill px-3 fw-bold btn-sm"><i class="fa fa-print me-1"></i> Jahresbericht</a>
                            <button class="btn btn-danger rounded-pill px-4 shadow btn-sm fw-bold" @click="createNew"><i class="fa fa-plus me-1"></i> Neu</button>
                        </div>
                    </div>
                    <div class="row g-2 g-md-3 mb-4">
                        <div class="col-4"><div class="stat-card" style="background: var(--exercise-color);"><div class="stat-label">Übungen</div><div class="stat-val">{{catStats.Übung}}h</div></div></div>
                        <div class="col-4"><div class="stat-card" style="background: var(--incident-color);"><div class="stat-label">Einsätze</div><div class="stat-val">{{catStats.Einsatz}}h</div></div></div>
                        <div class="col-4"><div class="stat-card text-dark" style="background: var(--misc-color);"><div class="stat-label">Sonstiges</div><div class="stat-val">{{catStats.Sonstiges}}h</div></div></div>
                    </div>
                    <div class="card rank-card">
                        <div class="card-header bg-white py-3 border-0 rounded-top-4" @click="showRanking = !showRanking" style="cursor:pointer">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="d-flex align-items-center">
                                    <h6 class="m-0 fw-bold text-uppercase small" style="letter-spacing: 1px; color: #555;"><i class="fa fa-trophy text-warning me-2"></i>Ranking</h6>
                                    <div v-if="!showRanking && ranking.length > 0" class="ms-3">
                                        <span class="badge rounded-pill bg-warning text-dark px-3 py-2 shadow-sm small"><i class="fa fa-crown me-1"></i> #1 {{ ranking[0].name }}</span>
                                    </div>
                                </div>
                                <i class="fa text-muted small" :class="showRanking?'fa-chevron-up':'fa-chevron-down'"></i>
                            </div>
                        </div>
                        <div v-show="showRanking" class="table-responsive px-3 pb-3">
                            <table class="table table-hover mb-0 align-middle">
                                <thead><tr class="text-muted small"><th>PLATZ</th><th>KAMERAD</th><th class="text-center">STUNDEN</th><th class="text-center">DIENSTE</th></tr></thead>
                                <tbody><tr v-for="(p, i) in ranking" :key="p.id" class="border-0"><td><div class="rank-badge" :class="'rank-'+(i+1)">{{i+1}}</div></td><td><span class="fw-bold">{{ p.name }}</span></td><td class="text-center"><span class="badge bg-light text-dark rounded-pill px-3">{{ p.total_hours }}h</span></td><td class="text-center small text-muted fw-bold">{{ p.present_count }} / {{ p.total_sessions }}</td></tr></tbody>
                            </table>
                        </div>
                    </div>
                    <div v-for="s in sessions" :key="s.id" class="session-item shadow-sm" @click="loadSession(s)">
                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                            <div class="d-flex gap-4 align-items-center">
                                <div class="text-center bg-light rounded-4 p-2 shadow-sm" style="min-width: 60px; border: 1px solid #eee;"><div class="fw-bold text-danger h5 m-0">{{ s.date.split('-')[2] }}</div><div class="small text-muted fw-bold" style="font-size: 0.6rem;">{{ s.date.split('-')[1] }}.{{ s.date.split('-')[0].substring(2) }}</div></div>
                                <div><span class="badge rounded-pill mb-1 shadow-sm small" :class="s.category==='Einsatz'?'bg-danger':(s.category==='Sonstiges'?'bg-warning text-dark':'bg-primary')">{{ s.category }}</span><div class="fw-bold">{{ s.description }}</div><small class="text-muted fw-bold"><i class="fa fa-clock me-1"></i>{{ s.duration }}h</small></div>
                            </div>
                            <div class="d-flex gap-2">
                                <button v-if="isAdmin" class="btn btn-xs btn-outline-dark rounded-pill fw-bold px-3 py-1" style="font-size:0.65rem;" @click.stop="openSig(s)"><i class="fa fa-signature me-1"></i> Leitung</button>
                                <button v-if="isAdmin" class="btn btn-xs btn-dark rounded-pill fw-bold px-3 py-1" style="font-size:0.65rem;" @click.stop="openReport(s)">{{ s.category==='Einsatz'?'Einsatzbericht':'Bericht' }}</button>
                                <button v-if="isAdmin" class="btn-icon ms-2" @click.stop="deleteSession(s)"><i class="fa fa-trash-alt small"></i></button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="sigModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content border-0 rounded-4 shadow-lg"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Unterschrift Leitung</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-4"><div class="sig-wrapper shadow-inner"><canvas id="sigCanvas"></canvas></div></div><div class="modal-footer border-0 justify-content-between pt-0"><button class="btn btn-light rounded-pill px-4" @click="clearSig">Löschen</button><button class="btn btn-danger rounded-pill px-5 fw-bold shadow" @click="saveSig">OK</button></div></div></div></div>
    </div>
    <script>
        const { createApp } = Vue;
        let sigPad = null, sigModal = null;
        createApp({
            data() { return { isAdmin: false, groups: [], selectedGroup: null, mobileSelectedId: null, sessionsList: [], selectedYear: new Date().getFullYear(), ranking: [], showRanking: false, catStats: { Übung: 0, Einsatz: 0, Sonstiges: 0 }, updateCountdown: 0 } },
            computed: { sessions() { return this.sessionsList.filter(s => new Date(s.date).getFullYear() === this.selectedYear); } },
            async mounted() {
                this.isAdmin=(localStorage.getItem('userRole')==='admin');
                await this.loadGroups();
                sigPad = new SignaturePad(document.getElementById('sigCanvas'), { backgroundColor: 'white' });
                sigModal = new bootstrap.Modal(document.getElementById('sigModal'));
            },
            methods: {
                async loadGroups() { this.groups = await(await fetch('/groups')).json(); if(this.groups.length && !this.selectedGroup) this.selectGroup(this.groups[0]); },
                selectGroup(g) { if(!g) return; this.selectedGroup=g; this.mobileSelectedId=g.id; this.loadData(); },
                onMobileGroupChange() { this.selectGroup(this.groups.find(x => x.id == this.mobileSelectedId)); },
                async loadData() {
                    const res = await fetch(`/groups/${this.selectedGroup.id}/sessions`);
                    this.sessionsList = await res.json();
                    const sRes = await fetch(`/groups/${this.selectedGroup.id}/stats?year=${this.selectedYear}`);
                    this.ranking = (await sRes.json()).persons;
                    this.calcStats();
                },
                calcStats() {
                    const s={Übung:0,Einsatz:0,Sonstiges:0};
                    this.sessions.forEach(x=>{if(s[x.category]!==undefined)s[x.category]+=x.duration;});
                    this.catStats=s;
                },
                loadSession(s) { window.location.href=`/editor?group_id=${this.selectedGroup.id}&session_id=${s.id}`; },
                createNew() { window.location.href=`/editor?group_id=${this.selectedGroup.id}`; },
                openReport(s) { window.open(`/sessions/${s.id}/report`, '_blank'); },
                openSig(s) { this.activeS=s; sigModal.show(); },
                async saveSig() {
                    await fetch(`/sessions/${this.activeS.id}/leader_signature`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({signature: sigPad.toDataURL()}) });
                    sigModal.hide(); this.loadData();
                },
                clearSig() { sigPad.clear(); },
                async runSystemUpdateAction() {
                    if(!confirm("System jetzt aktualisieren?")) return;
                    const pin = prompt("Admin-PIN:");
                    if(!pin) return;
                    fetch(`/api/system/update?pin=${pin}`);
                    this.updateCountdown = 8;
                    const timer = setInterval(() => {
                        this.updateCountdown--;
                        if(this.updateCountdown <= 0) { clearInterval(timer); location.reload(true); }
                    }, 1000);
                },
                async addGroup() { const n=prompt("Name:"); if(n) { await fetch('/groups',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})}); this.loadGroups(); }},
                async editGroup(g) { const n=prompt("Name:", g.name); if(n) { await fetch(`/groups/${g.id}`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:n})}); this.loadGroups(); }},
                async deleteGroup(g) { if(confirm("Löschen?")) { await fetch(`/groups/${g.id}`,{method:'DELETE'}); this.loadGroups(); }},
                async deleteSession(s) { if(confirm("Löschen?")) { await fetch(`/sessions/${s.id}`,{method:'DELETE'}); this.loadData(); }},
                showAbout() { alert("Digitales Dienstbuch\nVersion: 1.58"); },
                async promptAdmin() { 
                    const p=prompt("Admin PIN:"); 
                    if(p) { 
                        const r=await fetch('/api/verify_admin',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({pin:p})}); 
                        if((await r.json()).success){ this.isAdmin=true; localStorage.setItem('userRole','admin'); location.reload(); }
                        else { alert("Falsche PIN!"); }
                    }
                },
                fullLogout() { localStorage.removeItem('userRole'); window.location.href = '/'; },
                logoutAdminOnly() { localStorage.setItem('userRole', 'user'); location.reload(); }
            }
        }).mount('#app');
    </script>
</body>
</html>
